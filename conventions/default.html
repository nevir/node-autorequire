<!DOCTYPE html><html lang="en"><head><title>conventions/default</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="conventions/default"><meta name="groc-project-path" content="src/conventions/default.coffee"><meta name="groc-github-url" content="https://github.com/nevir/node-autorequire"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="nv">ModuleGroupFactory = </span><span class="nx">require</span> <span class="s1">&#39;../module_group_factory&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>This convention attempts to adhere to a sane and relatively "standard" set of principles that
should work for most node modules.</p>

<p>Of course, there really isn't anything close to a standard naming &amp; package layout style, so
you might want to take a look at the other conventions if the defaults don't do it for you.
Or write your own!</p>

<p>Any options not specified in any other conventions fall back to those defined in this one.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="an-example">An Example</h2>

<p>Given this project hierarchy:</p>

<pre><code>lib/
  things-and-baubles/
    stuff/
      moo.js
    gizmo.js
    many-doohickey.js
  fizz.js
  fizz_bam.js
</code></pre>

<p>The exported module hierarchy will be as follows (assuming that lib/ is autorequired):</p>

<pre><code>{
  thingsAndBaubles: {
    stuff: {
      moo: &lt;module.exports from moo.js&gt;
    },
    gizmo: &lt;module.exports from gizmo.js&gt;
    manyDoohickey: &lt;module.exports from many-doohickey.js&gt;
  },
  fizz: &lt;module.exports from fizz.js&gt;
  fizzBam: &lt;module.exports from fizz_bam.js&gt;
}
</code></pre></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">Default</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="core-functionality">Core Functionality</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Given a directory, build and return the root module group for it.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">buildRootModuleGroup: </span><span class="nf">(rootPath) -&gt;</span>
    <span class="nx">ModuleGroupFactory</span><span class="p">.</span><span class="nx">buildModuleGroup</span> <span class="err">@</span><span class="p">,</span> <span class="nx">rootPath</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="naming-conventions">Naming Conventions</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>You can special case specific module names by defining them keyed on the file name without an
extension.  For example: {cli: 'CLI'} would force cli.js to be named CLI.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">specialCaseModuleNames: </span><span class="p">{}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Given a directory name and parent path, return the property name that should be used to
represent it in the module's hierarchy.</p>

<p>The default is to convert to a <code>camelCase</code> style (splitting on - and _).</p></div></div><div class="code"><div class="wrapper">  <span class="nv">directoryToProperty: </span><span class="nf">(directoryName, parentPath) -&gt;</span>
    <span class="nx">@specialCaseModuleNames</span><span class="p">[</span><span class="nx">directoryName</span><span class="p">]</span> <span class="o">or</span> <span class="nx">@camelCase</span> <span class="nx">directoryName</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Given a file name and parent path, return the property that should be used to represent it in
the module's hierarchy.</p>

<p>The default is to expose the file's exports as a <code>camelCase</code> form of the file name.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">fileToProperty: </span><span class="nf">(fileName, parentPath) -&gt;</span>
    <span class="nv">baseName = </span><span class="nx">@stripFileExtension</span> <span class="nx">fileName</span>

    <span class="nx">@specialCaseModuleNames</span><span class="p">[</span><span class="nx">baseName</span><span class="p">]</span> <span class="o">or</span> <span class="nx">@camelCase</span> <span class="nx">baseName</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="autorequired-source-evaluation">Autorequired Source Evaluation</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gives the convention an opportunity to modify the sandbox of an autorequired source file before
it is loaded.  Returns the sandbox that was modified (in case you want to replace it).</p>

<p>By default, this registers several sets of globals for the module.  See [<code>globalLazyLoads</code>]
(#section-13).</p></div></div><div class="code"><div class="wrapper">  <span class="nv">modifySandbox: </span><span class="nf">(sandbox, module) -&gt;</span>
    <span class="nv">module._globalLazyLoads = </span><span class="nx">@globalLazyLoads</span><span class="p">(</span><span class="nx">module</span><span class="p">)</span>
    <span class="nv">module._require         = </span><span class="nx">sandbox</span><span class="p">.</span><span class="nx">require</span>

    <span class="nx">sandbox</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gives the convention an opportunity to modify the source of a file before it is loaded.
Returns the modified source.</p>

<p>By default, this works in concert with <a href="#section-13"><code>globalLazyLoads</code></a> and sets up the
registered properties to be lazy loaded.  We have to drop down to the source level because
the module is evaluated in a sandboxed context.  The global context is shallow copied when
entering or leaving the sandbox, and getter/setter properties are not preserved.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">modifySource: </span><span class="nf">(source, module) -&gt;</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    for (var key in module._globalLazyLoads) {</span>
<span class="s2">      try {</span>
<span class="s2">        Object.defineProperty(global, key, {</span>
<span class="s2">          enumerable: false, configurable: true, get: module._globalLazyLoads[key]</span>
<span class="s2">        });</span>
<span class="s2">      } catch (err) {}</span>
<span class="s2">    }</span>
<span class="s2">    &quot;&quot;&quot;</span> <span class="o">+</span> <span class="nx">source</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Gives the convention an opportunity to modify the exports before they are returned.  The
convention can also peek into the state of the sandbox after evaluation if it wishes to pull out
any properties defined globally within the evaluated module.  Returns the modified exports.</p>

<p>By default, this is a no-op.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">modifyExports: </span><span class="nf">(exports, module) -&gt;</span>
    <span class="nx">exports</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="autorequired-module-globals">Autorequired Module Globals</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Modules to globally register for autorequiring.  All the core node libraries.</p>

<p>Each one will be registered with a name adhering to <a href="#section-4"><code>directoryToProperty</code></a>.
Notably absent is module, as it defines a prototype (and is not a namespaced module).</p>

<p>You probably don't want to override this list.  If you wish to add extra modules, define them
via <a href="#section-12"><code>extraGlobalAutorequires</code></a></p></div></div><div class="code"><div class="wrapper">  <span class="nv">globalModules: </span><span class="p">[</span>
    <span class="s1">&#39;assert&#39;</span><span class="p">,</span> <span class="s1">&#39;buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;child_process&#39;</span><span class="p">,</span> <span class="s1">&#39;constants&#39;</span><span class="p">,</span> <span class="s1">&#39;crypto&#39;</span><span class="p">,</span> <span class="s1">&#39;dgram&#39;</span><span class="p">,</span> <span class="s1">&#39;dns&#39;</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">,</span>
    <span class="s1">&#39;freelist&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;http&#39;</span><span class="p">,</span> <span class="s1">&#39;https&#39;</span><span class="p">,</span> <span class="s1">&#39;net&#39;</span><span class="p">,</span> <span class="s1">&#39;os&#39;</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;querystring&#39;</span><span class="p">,</span> <span class="s1">&#39;readline&#39;</span><span class="p">,</span> <span class="s1">&#39;repl&#39;</span><span class="p">,</span>
    <span class="s1">&#39;stream&#39;</span><span class="p">,</span> <span class="s1">&#39;string_decoder&#39;</span><span class="p">,</span> <span class="s1">&#39;sys&#39;</span><span class="p">,</span> <span class="s1">&#39;timers&#39;</span><span class="p">,</span> <span class="s1">&#39;tls&#39;</span><span class="p">,</span> <span class="s1">&#39;tty&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;util&#39;</span><span class="p">,</span> <span class="s1">&#39;vm&#39;</span>
  <span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Any additional modules to add to the <a href="#section-13"><code>globalLazyLoads</code></a> without modifying that
list.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">extraGlobalModules: </span><span class="p">[]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Returns an object of properties that should be lazy loaded as global objects in an autorequired
source file.</p>

<p>It should be a map of property names to functions (that will be called on first reference, the
result is then memoized).</p>

<p>This registers several sets of globals for the module:</p></div></div><div class="code"><div class="wrapper">  <span class="nv">globalLazyLoads: </span><span class="nf">(module) -&gt;</span>
    <span class="nv">result = </span><span class="p">{}</span>

    <span class="nx">@appendGlobalModules</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span>
    <span class="nx">@appendProjectModules</span><span class="p">(</span><span class="nx">result</span><span class="p">,</span> <span class="nx">module</span><span class="p">)</span>

    <span class="nx">result</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>All globals defined in <code>appendGlobalModules</code> are registered to be autorequired.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">appendGlobalModules: </span><span class="nf">(lazyLoads, module) -&gt;</span>
    <span class="k">for</span> <span class="nx">mod</span> <span class="k">in</span> <span class="nx">@globalModules</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@extraGlobalModules</span>
      <span class="nx">do</span> <span class="p">(</span><span class="nx">mod</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">lazyLoads</span><span class="p">[</span><span class="nx">@directoryToProperty</span><span class="p">(</span><span class="nx">mod</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="nx">module</span><span class="p">.</span><span class="nx">_require</span> <span class="nx">mod</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ul>
<li>All autorequireable properties visible to the current directory and above.</li>
</ul></div></div><div class="code"><div class="wrapper">  <span class="nv">appendProjectModules: </span><span class="nf">(lazyLoads, module) -&gt;</span>
    <span class="nv">moduleGroup = </span><span class="nx">module</span><span class="p">.</span><span class="nx">autorequireParent</span>

    <span class="k">while</span> <span class="nx">moduleGroup</span>
      <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">moduleGroup</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Don't allow ambiguous properties</p></div></div><div class="code"><div class="wrapper">        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Ambiguous property &#39;#{key}&#39;&quot;</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">lazyLoads</span> <span class="c1"># TODO: Better error</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>And don't proxy the current module</p></div></div><div class="code"><div class="wrapper">        <span class="k">continue</span> <span class="k">if</span> <span class="nx">key</span> <span class="o">==</span> <span class="nx">module</span><span class="p">.</span><span class="nx">id</span>

        <span class="nx">do</span> <span class="nf">(key, moduleGroup) -&gt;</span> <span class="nx">lazyLoads</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="nx">moduleGroup</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

      <span class="nv">moduleGroup = </span><span class="nx">moduleGroup</span><span class="p">.</span><span class="nx">__parent</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For example, from within <code>lib/things/gizmo.js</code> (as part of the example outlined above):</p>

<ul>
<li>You can reference any of the core node libraries without requiring them.</li>
<li><code>ManyDoohickey</code> and <code>stuff</code> would be available for referencing.</li>
<li><code>things</code> would also be available in order to traverse up the hierarchy.</li>
</ul>

<p>Every one of these properties is lazy-loaded.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="helpers-amp-utility">Helpers &amp; Utility</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Strips the extension from a file name.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">stripFileExtension: </span><span class="nf">(fileName) -&gt;</span>
    <span class="nx">fileName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(.+?)(\.[^.]*$|$)/</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>CamelCaps a path component.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">camelCaps: </span><span class="nf">(pathComponent) -&gt;</span>
    <span class="nx">pathComponent</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/[-_]+/</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nf">(val) -&gt;</span> <span class="nx">val</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toLocaleUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">val</span><span class="p">[</span><span class="mi">1</span><span class="p">..]).</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>camelCase a path component.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">camelCase: </span><span class="nf">(pathComponent) -&gt;</span>
    <span class="nv">result = </span><span class="nx">@camelCaps</span> <span class="nx">pathComponent</span>
    <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toLocaleLowerCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">result</span><span class="p">[</span><span class="mi">1</span><span class="p">..]</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>under_score a path component.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">underscore: </span><span class="nf">(pathComponent) -&gt;</span>
    <span class="nx">pathComponent</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/[-_]+/</span><span class="p">).</span><span class="nx">join</span> <span class="s1">&#39;_&#39;</span>

<span class="nv">module.exports = </span><span class="nx">Default</span></div></div></div></div></body></html>